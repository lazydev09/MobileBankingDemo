
/**
*
* Copyright Â© 2009-2011 Apple Inc.  All rights reserved.
*
**/

iAd.Class({name:"iAd.TransitionController",superclass:iAd.ViewController,synthesizedProperties:["visibleViewController","cachedViewControllers","loadingViewController"],archivedProperties:["visibleViewController","previouslyVisibleViewController","loadingViewController","loadingViewControllerMinimumDisplayTime"]});iAd.TransitionController.WILL_MAKE_VIEW_CONTROLLER_VISIBLE="transitionControllerWillMakeViewControllerVisibleAnimated";iAd.TransitionController.DID_MAKE_VIEW_CONTROLLER_VISIBLE="transitionControllerDidMakeViewControllerVisibleAnimated";iAd.TransitionController.VIEW_IS_VISIBLE_STATE="ad-transition-controller-visible";iAd.TransitionController.VIEW_IS_HIDDEN_STATE="ad-transition-controller-hidden";iAd.TransitionController.VIEW_BUILDS_IN_STATE="ad-view-builds-in";iAd.TransitionController.VIEW_BUILDS_OUT_STATE="ad-view-builds-out";iAd.TransitionController.VIEW_BUILDS_IN_ACTION_LIST_CLASS="ad-view-builds-in-action-list";iAd.TransitionController.VIEW_BUILDS_OUT_ACTION_LIST_CLASS="ad-view-builds-out-action-list";iAd.TransitionController.VIEW_IDLE_STATE="ad-view-is-idle";iAd.TransitionController.DEFAULT_TRANSITION_DURATION=0.35;iAd.TransitionController.WAITING_ON_DISPLAY_CSS_CLASS="ad-waiting-on-display";iAd.TransitionController.prototype.init=function(b,a){this.callSuper(b);this._cachedViewControllers=[];this._visibleViewController=null;this._loadingViewController=null;this.loadingViewControllerMinimumDisplayTime=0;this.loadingViewControllerVisible=false;this.delegate=null;this.hidesLoadingViewControllerWithTransition=true;this.previouslyVisibleViewController=null;this.busy=false;if(a!=undefined){this.visibleViewController=a}};iAd.TransitionController.prototype.loadView=function(){this.view=new iAd.TransitionControllerView()};iAd.TransitionController.prototype.setCachedViewControllers=function(c){var a;var e=this._cachedViewControllers;for(var b=0,d=e.length;b<d;b++){a=e[b];if(a!==this._visibleViewController&&c.indexOf(a)==-1){a.view.removeFromSuperview()}}for(b=0,d=c.length;b<d;b++){a=c[b];if(a!==this._visibleViewController&&e.indexOf(a)==-1){this.attachViewController(a)}}this._cachedViewControllers=c.slice()};iAd.TransitionController.prototype.attachViewController=function(b){var a=b.view;a.layer.addClassName(iAd.TransitionController.WAITING_ON_DISPLAY_CSS_CLASS);if(a.superview!==this._view){this._view.addSubview(a)}};iAd.TransitionController.prototype.setVisibleViewController=function(a){this.setVisibleViewControllerAnimated(a,false)};iAd.TransitionController.prototype.setVisibleViewControllerAnimated=function(b,a){if(this.busy||this._visibleViewController===b){return}iAd.RootViewController.sharedRootViewController.beginIgnoringInteractionEvents();this.transitionIsDelayedByPreviouslyVisibleViewController=false;this.previouslyVisibleViewController=this._visibleViewController;this._visibleViewController=b;if(b){b._transitionController=this}if(this.previouslyVisibleViewController!=null){this.previouslyVisibleViewController.viewWillDisappear(a);this.transitionIsDelayedByPreviouslyVisibleViewController=this.prepareToHideViewController(this.previouslyVisibleViewController)}if(b==null){this.performTransitionToViewController(b,a);return}this.attachViewController(b);this.nextVisibleViewController=b;this.willUseAnimationToTransitionToNextVisibleViewController=a;if(!this.transitionIsDelayedByPreviouslyVisibleViewController){this.previousViewControllerDidUnblockTransitions()}if(!b.isViewLoaded()){b.addPropertyObserver("viewWasProcessed",this,"viewControllerFinishedProcessingView")}};iAd.TransitionController.prototype.performTransitionToViewController=function(c,b){if(c!=null){c.viewWillAppear(b)}this.dispatchNotification(iAd.TransitionController.WILL_MAKE_VIEW_CONTROLLER_VISIBLE,this.delegate,[["newlyVisibleViewController",c],["previouslyVisibleViewController",this.previouslyVisibleViewController],["animated",b]]);if(c!=null){this.prepareToShowViewController(c)}iAd.Transaction.begin();var d,a=null;this.busy=b;iAd.Transaction.begin();iAd.Transaction.defaults.duration=b?iAd.TransitionController.DEFAULT_TRANSITION_DURATION:0;if(this.previouslyVisibleViewController!=null){d=b?this.previouslyVisibleViewController.becomesHiddenTransition:null;if(d!=null){d=this.viewForTransition(this.previouslyVisibleViewController).applyTransition(d,false)}}if(c!=null){a=b?c.becomesVisibleTransition:null;if(a!=null){a=this.viewForTransition(c).applyTransition(a,false)}}if(a instanceof iAd.Transition){a.delegate=this}else{if(d instanceof iAd.Transition){d.delegate=this}else{b=false}}iAd.Transaction.commit();if(c!=null){if(a){setTimeout(function(){c.view.layer.removeClassName(iAd.TransitionController.WAITING_ON_DISPLAY_CSS_CLASS)},0)}else{c.view.layer.removeClassName(iAd.TransitionController.WAITING_ON_DISPLAY_CSS_CLASS)}}if(this.hidesLoadingViewControllerWithTransition){this.hideLoadingViewController()}iAd.Transaction.commit();if(!b){this.transitionDidComplete()}};iAd.TransitionController.prototype.performBuildInToViewController=function(b){var a=b.actionListNameByClassName[iAd.TransitionController.VIEW_BUILDS_IN_ACTION_LIST_CLASS];if(a){b.enterState(iAd.TransitionController.VIEW_BUILDS_IN_STATE);b.callMethodNameAfterDelay("startActionList",0,a)}};iAd.TransitionController.prototype.prepareToHideViewController=function(b){var c=false;b.exitState(iAd.TransitionController.VIEW_IS_VISIBLE_STATE);b.enterState(iAd.TransitionController.VIEW_IS_HIDDEN_STATE);b.exitState(iAd.TransitionController.VIEW_IDLE_STATE);var a=b.actionListNameByClassName[iAd.TransitionController.VIEW_BUILDS_OUT_ACTION_LIST_CLASS];if(a){b.enterState(iAd.TransitionController.VIEW_BUILDS_OUT_STATE);b.startActionList(a);if(b.buildOutActionListShouldDelayTransition){c=true}}return c};iAd.TransitionController.prototype.prepareToShowViewController=function(a){a.exitState(iAd.TransitionController.VIEW_BUILDS_OUT_STATE);a.exitState(iAd.TransitionController.VIEW_IS_HIDDEN_STATE);a.enterState(iAd.TransitionController.VIEW_IS_VISIBLE_STATE);a.exitState(iAd.TransitionController.VIEW_IDLE_STATE);if(!a.buildInActionListShouldOccurAfterTransition){this.performBuildInToViewController(a)}};iAd.TransitionController.prototype.viewControllerActionListDidComplete=function(d,a){if(!d.isInState(iAd.TransitionController.VIEW_BUILDS_IN_STATE)&&!d.isInState(iAd.TransitionController.VIEW_BUILDS_OUT_STATE)){return}var c=a.cssClassName;if(c===iAd.TransitionController.VIEW_BUILDS_OUT_ACTION_LIST_CLASS){d.exitState(iAd.TransitionController.VIEW_BUILDS_OUT_STATE);if(this.transitionIsDelayedByPreviouslyVisibleViewController){this.transitionIsDelayedByPreviouslyVisibleViewController=false;this.previousViewControllerDidUnblockTransitions()}else{if(d===this._loadingViewController){var b=(d.becomesHiddenTransition!=null);this.detachLoadingViewControllerAnimated(b);if(d.buildOutActionListShouldDelayTransition){this.showNextViewControllerIfReady()}}}}else{if(c===iAd.TransitionController.VIEW_BUILDS_IN_ACTION_LIST_CLASS){d.exitState(iAd.TransitionController.VIEW_BUILDS_IN_STATE);if(!this.busy){d.enterState(iAd.TransitionController.VIEW_IDLE_STATE);if(d===this._loadingViewController){this.showNextViewControllerIfReady()}}}}};iAd.TransitionController.prototype.viewControllerFinishedProcessingView=function(b,a){b.removePropertyObserver("viewWasProcessed",this);this.showNextViewControllerIfReady()};iAd.TransitionController.prototype.previousViewControllerDidUnblockTransitions=function(){var a=this.nextVisibleViewController;var b=a.viewLoadingDelaysTransition&&!a.isViewLoaded();if(!a.disableLoadingViewController&&this._loadingViewController&&b){this.showLoadingViewController();return}if(!b){this.performTransitionToViewController(a,this.willUseAnimationToTransitionToNextVisibleViewController)}};iAd.TransitionController.prototype.viewForTransition=function(b){var a=b.view;if(a.size.equals(iAd.Size.ZERO_SIZE)&&b.contentView!=null){a=b.contentView}return a};iAd.TransitionController.prototype.viewControllerViewDidAppear=function(b,a){if(b.buildInActionListShouldOccurAfterTransition){this.performBuildInToViewController(b)}b.viewDidAppear(a)};iAd.TransitionController.prototype.viewControllerViewDidDisappear=function(b,a){b.viewDidDisappear(a)};iAd.TransitionController.prototype.contentTransitionDidComplete=function(b){iAd.RootViewController.sharedRootViewController.endIgnoringInteractionEvents();var a=this._wasAnimatedTransition=this.busy;if(this.previouslyVisibleViewController!=null){if(this._cachedViewControllers.indexOf(this.previouslyVisibleViewController)==-1){this.previouslyVisibleViewController.view.removeFromSuperview()}else{this.previouslyVisibleViewController.view.layer.addClassName(iAd.TransitionController.WAITING_ON_DISPLAY_CSS_CLASS)}this.viewControllerViewDidDisappear(this.previouslyVisibleViewController,a)}if(this._visibleViewController!=null){if(this.loadingViewControllerVisible&&!this.hidesLoadingViewControllerWithTransition){this.hideLoadingViewController()}else{this.notifyVisibleViewControllerDidAppear()}}this.busy=false;this.dispatchNotification(iAd.TransitionController.DID_MAKE_VIEW_CONTROLLER_VISIBLE,this.delegate,[["newlyVisibleViewController",this._visibleViewController],["previouslyVisibleViewController",this.previouslyVisibleViewController],["animated",a]])};iAd.TransitionController.prototype.notifyVisibleViewControllerDidAppear=function(){this.viewControllerViewDidAppear(this._visibleViewController,this._wasAnimatedTransition);this._wasAnimatedTransition=false;var a=this._visibleViewController.actionListNameByClassName[iAd.TransitionController.VIEW_BUILDS_IN_ACTION_LIST_CLASS];if(!a||!this._visibleViewController.isInState(iAd.TransitionController.VIEW_BUILDS_IN_STATE)){this._visibleViewController.enterState(iAd.TransitionController.VIEW_IDLE_STATE)}};iAd.TransitionController.prototype.setLoadingViewController=function(a){if(this.loadingViewControllerVisible){return}if(a&&!a.isViewLoading()&&!a.isViewLoaded()){this.attachViewController(a)}this._loadingViewController=a;if(a){a._transitionController=this}};iAd.TransitionController.prototype.showLoadingViewController=function(){if(this.loadingViewControllerVisible||this._loadingViewController==null){return}var c=this._loadingViewController;var b=c.view;var a=(c.becomesVisibleTransition!=null);c.view.layer.removeClassName(iAd.TransitionController.WAITING_ON_DISPLAY_CSS_CLASS);c.viewWillAppear(a);this.prepareToShowViewController(this._loadingViewController);if(a){b.size=this._view.size.copy();b.autoresizingMask=iAd.View.AUTORESIZING_FLEXIBLE_WIDTH|iAd.View.AUTORESIZING_FLEXIBLE_HEIGHT;var d=b.applyTransition(c.becomesVisibleTransition,false);d.delegate=this}this._view.addSubview(b);this.loadingViewControllerVisible=true;if(this.loadingViewControllerMinimumDisplayTime>0){this.loadingViewDisplayTime=new Date();this.callMethodNameAfterDelay("showNextViewControllerIfReady",this.loadingViewControllerMinimumDisplayTime)}if(!a){this.viewControllerViewDidAppear(c,false);this.showNextViewControllerIfReady()}};iAd.TransitionController.prototype.hideLoadingViewController=function(){if(!this.loadingViewControllerVisible){return}var b=this._loadingViewController;if(b.isInState(iAd.ViewController.VIEW_WILL_DISAPPEAR_STATE)){return}var a=(b.becomesHiddenTransition!=null);b.viewWillDisappear(a);this.prepareToHideViewController(b);var c=b.actionListNameByClassName[iAd.TransitionController.VIEW_BUILDS_OUT_ACTION_LIST_CLASS];if(!c){this.detachLoadingViewControllerAnimated(a)}};iAd.TransitionController.prototype.detachLoadingViewControllerAnimated=function(b){var a=this._loadingViewController;if(b){var c=a.view.applyTransition(a.becomesHiddenTransition,false);c.delegate=this}else{a.view.removeFromSuperview();this.viewControllerViewDidDisappear(a,false)}this.loadingViewControllerVisible=false};iAd.TransitionController.prototype.loadingViewControllerTransitionDidComplete=function(a){if(this.loadingViewControllerVisible){this.viewControllerViewDidAppear(this._loadingViewController,true);this.showNextViewControllerIfReady()}else{this._loadingViewController.view.removeFromSuperview();this.viewControllerViewDidDisappear(this._loadingViewController,true);if(!this.hidesLoadingViewControllerWithTransition){this.notifyVisibleViewControllerDidAppear()}}};iAd.TransitionController.prototype.showNextViewControllerIfReady=function(){if(this.transitionIsDelayedByPreviouslyVisibleViewController){return}if(this.loadingViewControllerVisible){var c=this._loadingViewController;if(c.isInState(iAd.TransitionController.VIEW_BUILDS_IN_STATE)||c.isInState(iAd.ViewController.VIEW_WILL_APPEAR_STATE)){return}if(this.loadingViewControllerMinimumDisplayTime>0){var a=(Date.now()-this.loadingViewDisplayTime)/1000;if(a<this.loadingViewControllerMinimumDisplayTime){return}}if(this.hidesLoadingViewControllerWithTransition){var d=c.actionListNameByClassName[iAd.TransitionController.VIEW_BUILDS_OUT_ACTION_LIST_CLASS];if(d&&c.buildOutActionListShouldDelayTransition){this.hideLoadingViewController();return}}}var b=this.nextVisibleViewController;if(b&&b.viewLoadingDelaysTransition&&!b.isViewLoaded()){return}if(b.isInState(iAd.ViewController.VIEW_WILL_APPEAR_STATE)||b.isInState(iAd.ViewController.VIEW_DID_APPEAR_STATE)){return}this.performTransitionToViewController(b,this.willUseAnimationToTransitionToNextVisibleViewController)};iAd.TransitionController.prototype.transitionDidComplete=function(a){if(a&&this._loadingViewController!=null&&a.target===this._loadingViewController.view){this.loadingViewControllerTransitionDidComplete(a)}else{this.contentTransitionDidComplete(a)}};iAd.Class({name:"iAd.TransitionControllerView",superclass:iAd.View,cssClassName:"ad-transition-controller-view"});iAd.TransitionControllerView.prototype.init=function(a){this.callSuper(a);this.autoresizingMask=iAd.View.AUTORESIZING_FLEXIBLE_WIDTH|iAd.View.AUTORESIZING_FLEXIBLE_HEIGHT};iAd.TransitionControllerView.prototype.willMoveToSuperview=function(a){this.callSuper(a);if(a!=null&&this._size.equals(iAd.Size.ZERO_SIZE)){this.size=a.size.copy()}};iAd.ViewController.prototype.getTransitionController=function(){return this._transitionController||this.parentControllerOfKind(iAd.TransitionController)};iAd.Class.synthesizeProperties(iAd.ViewController,["transitionController"]);iAd.RootViewController.prototype.getTransitionController=function(){if(!this.hasOwnProperty("_transitionController")){var b=iAd.RootView.sharedRoot;var a=new iAd.TransitionController();a.view.size=b.size.copy();a.delegate=this;b.addSubview(a.view,0);this._transitionController=a}return this._transitionController};iAd.Class.synthesizeProperties(iAd.RootViewController,["transitionController"]);