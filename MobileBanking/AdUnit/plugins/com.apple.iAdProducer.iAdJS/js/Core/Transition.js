
/**
*
* Copyright Â© 2009-2011 Apple Inc.  All rights reserved.
*
**/

iAd.Class({name:"iAd.Transition",mixins:[iAd.EventTarget]});iAd.Transition.DID_COMPLETE_DELEGATE="transitionDidComplete";iAd.Transition.DEFAULTS={duration:0.5,delay:0,removesTargetUponCompletion:false,revertsToOriginalValues:false};iAd.Transition.STYLES=["-webkit-transition-property","-webkit-transition-duration","-webkit-transition-timing-function","-webkit-transition-delay","-webkit-transition"];iAd.Transition.NORMALIZE_ZERO_REG_EXP=/([^\d+-]|^)[+-]?0[a-z%]*/g;iAd.Transition.HARDWARE_LAYER_BACKING_PROPERTIES=["position"];iAd.Transition.prototype.init=function(a,b){this.target=null;this.properties=null;this.base=null;this.duration=null;this.delay=null;this.from=null;this.to=null;this.timingFunction=null;this.delegate=null;this.removesTargetUponCompletion=null;this.revertsToOriginalValues=null;this.defaultsApplied=false;this.archivedStyles=null;this.archivedValues=[];this.archivedBaseValues=[];this.definition=a;this.reversed=!!b};iAd.Transition.prototype.applyDefaults=function(){if(this.defaultsApplied){return}for(var a in iAd.Transition.DEFAULTS){if(this[a]==null){this[a]=iAd.Transition.DEFAULTS[a]}}this.defaultsApplied=true};iAd.Transition.prototype.archiveTransitionStyles=function(){if(this.archivedStyles!=null){return}var b=(this.target instanceof iAd.View)?this.target.layer:this.target;this.archivedStyles=[];for(var a=0,c=iAd.Transition.STYLES.length;a<c;a++){this.archivedStyles.push(b.style.getPropertyValue(iAd.Transition.STYLES[a]))}};iAd.Transition.prototype.restoreTransitionStyles=function(){for(var a=0,b=iAd.Transition.STYLES.length;a<b;a++){this.element.style.setProperty(iAd.Transition.STYLES[a],this.archivedStyles[a],"")}this.archivedStyles=null};iAd.Transition.prototype.archiveBaseValues=function(){if(!this.revertsToOriginalValues){return}if(this.target instanceof iAd.View){for(var a=0,b=this.properties.length;a<b;a++){this.archivedValues[a]=this.target[this.properties[a]]}if(this.base){for(var a=0,b=this.base.length;a<b;a+=2){this.archivedBaseValues[a]=this.target[this.base[a]]}}}else{for(var a=0,b=this.properties.length;a<b;a++){this.archivedValues[a]=this.target.style.getPropertyValue(this.properties[a])}if(this.base){for(var a=0,b=this.base.length;a<b;a+=2){this.archivedBaseValues[a]=this.target.style.getPropertyValue(this.base[a])}}}};iAd.Transition.prototype.restoreBaseValues=function(){if(this.target instanceof iAd.View){for(var a=0,b=this.properties.length;a<b;a++){this.target[this.properties[a]]=this.archivedValues[a]}if(this.base){for(var a=0,b=this.base.length;a<b;a+=2){this.target[this.base[a]]=this.archivedBaseValues[a]}}}else{for(var a=0,b=this.properties.length;a<b;a++){this.target.style.setProperty(this.properties[a],this.archivedValues[a],null)}if(this.base){for(var a=0,b=this.base.length;a<b;a+=2){this.target.style.setProperty(this.base[a],this.archivedBaseValues[a],null)}}}};iAd.Transition.prototype.start=function(){if(iAd.Transaction.openTransactions>0){iAd.Transaction.addTransition(this)}else{this.applyFromState();iAd.CSS.flushPendingUpdates();this.callMethodNameAfterDelay("applyToState",0)}return this};iAd.Transition.prototype.applyFromState=function(){this.processDefinition();this.applyDefaults();this.archiveTransitionStyles();this.archiveBaseValues();this.enforceHardwareLayerBacking();if(this.from==null){return}if(this.target instanceof iAd.View){this.target.layer.style.webkitTransitionDuration=0;if(this.base){for(var a=0,b=this.base.length;a<b;a+=2){this.target[this.base[a]]=this.base[a+1]}}for(var a=0,b=this.properties.length;a<b;a++){this.target[this.properties[a]]=this.from[a]}}else{this.target.style.webkitTransitionDuration=0;if(this.base){for(var a=0,b=this.base.length;a<b;a+=2){this.target.style.setProperty(this.base[a],this.base[a+1],null)}}for(var a=0,b=this.properties.length;a<b;a++){this.target.style.setProperty(this.properties[a],this.from[a],null)}}};iAd.Transition.prototype.processDefinition=function(){if(!this.definition){return}var a=this.definition;if(iAd.Utils.objectIsFunction(a)){if(this.target!=null&&this.target instanceof iAd.View){a=a(this.target)}else{return}}iAd.Utils.copyPropertiesFromSourceToTarget(a,this);if(this.reversed){var b=this.from;this.from=this.to;this.to=b}};iAd.Transition.prototype.enforceHardwareLayerBacking=function(){if(this.target instanceof iAd.View){for(var a=0,b=this.properties.length;a<b;a++){if(iAd.Transition.HARDWARE_LAYER_BACKING_PROPERTIES.indexOf(this.properties[a])!=-1){this.target.wantsHardwareLayerBacking=true;return}}}};iAd.Transition.prototype.applyToState=function(){var e=(this.target instanceof iAd.View);this.cssProperties=[];var h=[];for(var b=0,d=this.properties.length;b<d;b++){var f=(e)?this.target.cssPropertyNameForJSProperty(this.properties[b]):this.properties[b];if(this.cssProperties.indexOf(f)>-1){continue}var g=(iAd.Utils.objectIsArray(this.duration))?this.duration[b]:this.duration;var c=(iAd.Utils.objectIsArray(this.timingFunction))?this.timingFunction[b]:this.timingFunction;var a=(iAd.Utils.objectIsArray(this.delay))?this.delay[b]:this.delay;h.push([f,g+"s",c,a+"s"].join(" "));if(!this.propertyStatesAreEqualForIndex(b)){this.cssProperties.push(f)}}this.element=e?this.target.layer:this.target;this.eventTarget=this.element;if(g!==0){this.element.addEventListener("webkitTransitionEnd",this,false)}this.completedTransitions=0;this.element.style.webkitTransition=h.join(", ");if(e){for(var b=0,d=this.properties.length;b<d;b++){this.target[this.properties[b]]=this.to[b]}}else{for(var b=0,d=this.properties.length;b<d;b++){this.target.style.setProperty(this.properties[b],this.to[b],"")}}if(!this.cssProperties.length){this.callMethodNameAfterDelay("handleTransitionComplete",0)}};iAd.Transition.prototype.propertyStatesAreEqualForIndex=function(a){var c=this.from==null?this.target[this.properties[a]]:this.from[a];var b=this.to[a];if((c instanceof iAd.Point&&b instanceof iAd.Point)||(c instanceof iAd.Size&&b instanceof iAd.Size)){return c.equals(b)}else{if(iAd.Utils.objectIsString(c)&&iAd.Utils.objectIsString(b)){c=c.replace(iAd.Transition.NORMALIZE_ZERO_REG_EXP,"$10");b=b.replace(iAd.Transition.NORMALIZE_ZERO_REG_EXP,"$10")}return c===b}};iAd.Transition.prototype.handleEvent=function(a){if(a.target!==this.element){return}this.completedTransitions++;if(this.completedTransitions!=this.cssProperties.length){return}this.handleTransitionComplete()};iAd.Transition.prototype.handleTransitionComplete=function(){this.dispatchNotification(iAd.Transition.DID_COMPLETE_DELEGATE,this.delegate);this.element.removeEventListener("webkitTransitionEnd",this,false);if(this.removesTargetUponCompletion){var a=this.target;if(this.target instanceof iAd.View){a.removeFromSuperview()}else{a.parentNode.removeChild(a)}}else{this.restoreTransitionStyles()}if(this.revertsToOriginalValues){this.restoreBaseValues()}};