
/**
*
* Copyright Â© 2009-2011 Apple Inc.  All rights reserved.
*
**/

iAd.Class({name:"iAP.MosaicView",superclass:iAd.View,synthesizedProperties:["image","rows","columns","transitionDuration","transition","revealStyle"],archivedProperties:["image","rows","columns","transitionDuration","transition","revealStyle"],cssClassName:"iap-mosaic-view",collectionAccessor:"mosaicViews"});iAP.MosaicView.TRANSITION_DISSOLVE="dissolve";iAP.MosaicView.TRANSITION_FLY_IN="flyIn";iAP.MosaicView.TRANSITION_FLIP="flip";iAP.MosaicView.TRANSITION_DOOR_LEFT="doorLeft";iAP.MosaicView.TRANSITION_DOOR_RIGHT="doorRight";iAP.MosaicView.TRANSITION_SLIDE="slide";iAP.MosaicView.TRANSITION_FALL="fall";iAP.MosaicView.TRANSITION_CUSTOM="custom";iAP.MosaicView.REVEAL_RANDOM="random";iAP.MosaicView.REVEAL_FORWARD="forward";iAP.MosaicView.REVEAL_BACKWARD="backward";iAP.MosaicView.REVEAL_PATTERN="pattern";iAP.MosaicView.REVEAL_PUZZLE="tetris";iAP.MosaicView.REVEAL_CASCADE="cascade";iAP.MosaicView.prototype.init=function(a){this._image=null;this._rows=8;this._columns=5;this._transitionDuration=5;this._transition=iAP.MosaicView.TRANSITION_DISSOLVE;this._revealStyle=iAP.MosaicView.REVEAL_RANDOM;this.revealTransitionsEnabled=true;this.tilePool=[];this.tiles=[];this._mosaicContainer=document.createElement("ul");this._mosaicContainer.addClassName("mosaic-list-container");this._mosaicContainer.addClassName(this._transition);this.callSuper(a);this.layer.appendChild(this._mosaicContainer);this.updateLayout();if(this.image){this.tilesEach(function(b){b.style.backgroundImage="url("+this.image.resolvedURL+")"})}iAd.Event.registerForNotificationEvent(iAd.ViewController.VIEW_DID_APPEAR_EVENT);document.addEventListener(iAd.ViewController.VIEW_DID_APPEAR_EVENT,this,false);iAd.Event.registerForNotificationEvent(iAd.ViewController.DID_ENTER_STATE);iAd.Event.registerForNotificationEvent(iAd.ViewController.DID_EXIT_STATE);document.addEventListener(iAd.ViewController.DID_ENTER_STATE,this,false);document.addEventListener(iAd.ViewController.DID_EXIT_STATE,this,false);if(iAd.Utils.isRunningInAdContext==false){window.addEventListener("resize",this,false)}};iAP.MosaicView.prototype.setValueForAttribute=function(b,a){if(a=="ad-image"){this.image=iAd.Image.imageForURL(b,this.layerHasCustomAttribute("ad-has-hidpi-version"))}else{this.callSuper(b,a)}};iAP.MosaicView.prototype.setSize=function(a){if(this.size.equals(a)){return}this.callSuper(a);this.updateLayout()};iAP.MosaicView.prototype.handleEvent=function(b){this.callSuper(b);var a=b.type;if((a==iAd.ViewController.DID_ENTER_STATE||a==iAd.ViewController.DID_EXIT_STATE)&&b.ad.state=="ad-landscape"){this.updateLayout()}else{if(a==iAd.ViewController.VIEW_DID_APPEAR_EVENT&&b.ad.sender.view.layer.contains(this.layer)){this.revealMosaic()}else{if(a=="resize"&&iAd.Utils.isRunningInAdContext==false){this.updateLayout()}}}};iAP.MosaicView.prototype.revealMosaic=function(){this._mosaicContainer.addClassName("active")};iAP.MosaicView.prototype.resetMosaic=function(){if(!this._mosaicContainer.hasClassName("no-animation")){this._mosaicContainer.addClassName("no-animation")}this._mosaicContainer.removeClassName("active")};iAP.MosaicView.prototype.setImage=function(a){if(iAd.Image.isEqual(this._image,a)){return}this._image=a;if(a){this.tilesEach(function(b){b.style.backgroundImage="url("+a.resolvedURL+")"})}};iAP.MosaicView.prototype.setRevealStyle=function(a){if(a!=this._revealStyle){this._revealStyle=a;this.applyTileDelay()}};iAP.MosaicView.prototype.setRows=function(a){if(a!=this._rows){this._rows=a;this.updateLayout()}};iAP.MosaicView.prototype.setColumns=function(a){if(a!=this._columns){this._columns=a;this.updateLayout()}};iAP.MosaicView.prototype.setTransition=function(a){if(this._mosaicContainer){this._mosaicContainer.removeClassName(this.transition);this._mosaicContainer.addClassName(a)}this._transition=a;this.callSuper(a)};iAP.MosaicView.prototype.setTransitionDuration=function(a){if(a!=this._transitionDuration){this._transitionDuration=a;this.applyTileDelay()}};iAP.MosaicView.prototype.populate=function(){var c=this.rows*this.columns,h=document.createDocumentFragment(),g,d,f;if(c>this.tilePool.length){for(d=this.tilePool.length;d<c;d++){g=document.createElement("li");if(this.image){g.style.backgroundImage="url("+this.image.resolvedURL+")"}this.tilePool.push(g);h.appendChild(g)}this._mosaicContainer.appendChild(h)}for(d=c,f=this.tiles.length;d<f;d++){this.tiles[d].style.display="none"}if(this.image&&this.tiles&&this.tiles.length<c){for(d=this.tiles.length;d<c;d++){this.tilePool[d].style.backgroundImage="url("+this.image.resolvedURL+")"}}this.tiles=this.tilePool.slice(0,c);var a=window.getComputedStyle(this.layer),b=parseInt(a.width,10),n=parseInt(a.height,10),m=b+"px "+n+"px",l=Math.ceil(b/this.columns),e=Math.ceil(n/this.rows),k,j;for(row=0;row<this.rows;row++){for(col=0;col<this.columns;col++){g=this.tiles[col+row*this.columns];k=col*l;j=row*e;g.style.display="block";g.style.height=e+"px";g.style.width=l+"px";g.style.backgroundPosition=(-k)+"px "+(-j)+"px";g.style.backgroundSize=m;g.style.left=k+"px";g.style.top=j+"px"}}};iAP.MosaicView.prototype.tilesEach=function(b){if(this.tiles){this.tilesEachFn=b;for(var a=0,c=this.tiles.length;a<c;a++){this.tilesEachFn(this.tiles[a],a,c)}}};iAP.MosaicView.prototype.tilesGridEach=function(b){if(this.tiles){this.tilesEachFn=b;var e,c,a,d;for(e=0,c=this.rows;e<c;e+=1){for(a=0,d=this.columns;a<d;a+=1){this.tilesEachFn(this.tiles[e*d+a],a,e)}}}};iAP.MosaicView.prototype.applyTileDelay=function(){if(!this.tiles||!this.tiles.length){return}switch(this.revealStyle){case iAP.MosaicView.REVEAL_RANDOM:var a=this.getShuffledArray(this.tiles.length);this.tilesEach(function(d,c,b){d.style.webkitTransitionDelay=(a[c]/b)*this.transitionDuration+"s"});break;case iAP.MosaicView.REVEAL_FORWARD:this.tilesEach(function(d,c,b){d.style.webkitTransitionDelay=(c/b)*this.transitionDuration+"s"});break;case iAP.MosaicView.REVEAL_BACKWARD:this.tilesEach(function(d,c,b){d.style.webkitTransitionDelay=(1-c/b)*this.transitionDuration+"s"});break;case iAP.MosaicView.REVEAL_PATTERN:this.tilesGridEach(function(c,b,d){c.style.webkitTransitionDelay=(this.transitionDuration/(this.rows+this.columns))*(b+d)+"s"});break;case iAP.MosaicView.REVEAL_PUZZLE:this.tilesGridEach(function(c,b,d){if(this.currentRow!==d){this.columnOrder=this.getShuffledArray(this.columns);this.currentRow=d}c.style.webkitTransitionDelay=(this.columnOrder[b]+((this.rows-d)*this.columns))/(this.tiles.length)*this.transitionDuration+"s"});this.currentRow=null;break;case iAP.MosaicView.REVEAL_CASCADE:default:this.tilesGridEach(function(c,b,d){if(this.currentRow!==d){this.columnOrder=this.getShuffledArray(this.columns);this.currentRow=d}c.style.webkitTransitionDelay=(this.columnOrder[b]+(d*this.columns))/(this.tiles.length)*this.transitionDuration+"s"});this.currentRow=null}};iAP.MosaicView.prototype.updateLayout=function(){this.populate();this.applyTileDelay()};iAP.MosaicView.prototype.getShuffledArray=function(a){var c=[];for(var b=0;b<a;b++){c.push(b)}return this.shuffleArray(c)};iAP.MosaicView.prototype.shuffleArray=function(d){var c=d.length;while(--c){var b=Math.floor(Math.random()*(c+1));var a=d[c];d[c]=d[b];d[b]=a}return d};