
/**
*
* Copyright Â© 2009-2011 Apple Inc.  All rights reserved.
*
**/

iAP.MultiView=iAd.Class({name:"iAP.MultiView",superclass:iAd.View,synthesizedProperties:["selectedView","buttonsPosition","buttonStyle","cellCount","transitionDuration","transition","direction","timingFunction","hidesButtonsDuringTransition","hidesButtons","hidesButtonsForLastCell","selectedIndex","initialIndex","numberOfCells"],archivedProperties:["selectedView","buttonsPosition","buttonStyle","cellCount","transitionDuration","transition","direction","timingFunction","hidesButtonsDuringTransition","hidesButtons","hidesButtonsForLastCell","selectedIndex","initialIndex","numberOfCells"],cssClassName:"iap-multi-view",collectionAccessor:"multiViews"});iAP.MultiView.BUTTON_HEIGHT=40;iAP.MultiView.BUTTON_WIDTH=40;iAP.MultiView.BUTTON_INSET=0;iAP.MultiView.BUTTON_ICON_STYLE_LIGHT="light";iAP.MultiView.BUTTON_ICON_STYLE_DARK="dark";iAP.MultiView.BUTTON_ICON_STYLE_NONE="none";iAP.MultiView.DIRECTION_UP="up";iAP.MultiView.DIRECTION_DOWN="down";iAP.MultiView.DIRECTION_LEFT="left";iAP.MultiView.DIRECTION_RIGHT="right";iAP.MultiView.BUTTONS_POSITION_TOP="top";iAP.MultiView.BUTTONS_POSITION_BOTTOM="bottom";iAP.MultiView.TIMING_FUNCTION_LINEAR="linear";iAP.MultiView.TIMING_FUNCTION_EASE_IN_OUT="ease-in-out";iAP.MultiView.TIMING_FUNCTION_EASE_OUT="ease-out";iAP.MultiView.DID_FOCUS_CELL_AT_INDEX="containerDidFocusCellAtIndex";iAP.MultiView.TRANSITION_IDENTITY={properties:["opacity","transform"],from:[0.99,"perspective(800) scale(1) translate3d(0, 0, 0) rotate3d(0, 1, 0, 0deg)"],to:[1,"perspective(800) scale(1) translate3d(0, 0, 0) rotate3d(0, 1, 0, 0deg)"]};iAP.MultiView.TRANSITION_ZOOM_TOWARDS_IN=iAd.View.TRANSITION_ZOOM_IN;iAP.MultiView.TRANSITION_ZOOM_TOWARDS_OUT={properties:["opacity","transform"],from:[1,"scale(1)"],to:[0,"scale(1.2)"]};iAP.MultiView.TRANSITION_ZOOM_AWAY_IN=iAd.View.TRANSITION_ZOOM_OUT;iAP.MultiView.TRANSITION_ZOOM_AWAY_OUT={properties:["opacity","transform"],from:[1,"scale(1)"],to:[0,"scale(0.2)"]};iAP.MultiView.TRANSITION_SLIDE_LEFT_IN={properties:["opacity","transform"],from:[0,"translate3d(150%, 0, 0)"],to:[1,"translate3d(  0%, 0, 0)"]};iAP.MultiView.TRANSITION_SLIDE_LEFT_OUT={properties:["opacity","transform"],from:[1,"translate3d(   0%, 0, 0)"],to:[0,"translate3d(-150%, 0, 0)"]};iAP.MultiView.TRANSITION_SLIDE_RIGHT_IN={properties:["opacity","transform"],from:[0,"translate3d(-150%, 0, 0)"],to:[1,"translate3d(   0%, 0, 0)"]};iAP.MultiView.TRANSITION_SLIDE_RIGHT_OUT={properties:["opacity","transform"],from:[1,"translate3d(  0%, 0, 0)"],to:[0,"translate3d(150%, 0, 0)"]};iAP.MultiView.TRANSITION_SLIDE_FLIP_LEFT_IN={base:["anchorPoint",new iAd.Point(0,0.5)],properties:["transform"],from:["translate3d(100%, 0, 0) rotate3d(0, 1, 0, 180deg)"],to:["translate3d(  0%, 0, 0) rotate3d(0, 1, 0,   0deg)"]};iAP.MultiView.TRANSITION_SLIDE_FLIP_LEFT_OUT={base:["anchorPoint",new iAd.Point(1,0.5)],properties:["transform"],from:["translate3d(   0%, 0, 0) rotate3d(0, 1, 0,    0deg)"],to:["translate3d(-100%, 0, 0) rotate3d(0, 1, 0, -180deg)"]};iAP.MultiView.TRANSITION_SLIDE_FLIP_RIGHT_IN={base:["anchorPoint",new iAd.Point(1,0.5)],properties:["transform"],from:["translate3d(-100%, 0, 0) rotate3d(0, 1, 0, -180deg)"],to:["translate3d(   0%, 0, 0) rotate3d(0, 1, 0,    0deg)"]};iAP.MultiView.TRANSITION_SLIDE_FLIP_RIGHT_OUT={base:["anchorPoint",new iAd.Point(0,0.5)],properties:["transform"],from:["translate3d(  0%, 0, 0) rotate3d(0, 1, 0,   0deg)"],to:["translate3d(100%, 0, 0) rotate3d(0, 1, 0, 180deg)"]};iAP.MultiView.TRANSITION_DOOR_OPEN_LEFT_IN=iAP.MultiView.TRANSITION_IDENTITY;iAP.MultiView.TRANSITION_DOOR_CLOSE_LEFT_OUT=iAP.MultiView.TRANSITION_IDENTITY;iAP.MultiView.TRANSITION_DOOR_OPEN_RIGHT_IN=iAP.MultiView.TRANSITION_IDENTITY;iAP.MultiView.TRANSITION_DOOR_CLOSE_RIGHT_OUT=iAP.MultiView.TRANSITION_IDENTITY;iAP.MultiView.TRANSITION_CROSS_SPIN_RIGHT_IN=iAd.View.TRANSITION_CROSS_SPIN_RIGHT;iAP.MultiView.TRANSITION_CROSS_SPIN_RIGHT_OUT={properties:["opacity","transform"],from:[1,"rotate(0)"],to:[0,"rotate(20deg)"]};iAP.MultiView.TRANSITION_CROSS_SPIN_LEFT_IN=iAd.View.TRANSITION_CROSS_SPIN_LEFT;iAP.MultiView.TRANSITION_CROSS_SPIN_LEFT_OUT={properties:["opacity","transform"],from:[1,"rotate(0)"],to:[0,"rotate(-20deg)"]};iAP.MultiView.TRANSITION_REVOLVE_TOWARDS_RIGHT_IN={base:["anchorPoint",new iAd.Point(1,0.5)],properties:["opacity","transform"],from:[0,"perspective(800) rotateY(-90deg)"],to:[1,"perspective(800) rotateY(  0deg)"]};iAP.MultiView.TRANSITION_REVOLVE_TOWARDS_LEFT_IN={base:["anchorPoint",new iAd.Point(0,0.5)],properties:["opacity","transform"],from:[0,"perspective(800) rotateY(90deg)"],to:[1,"perspective(800) rotateY(0deg)"]};iAP.MultiView.TRANSITION_SPIN_LEFT_IN={base:["zIndex",1],properties:["transform","opacity"],from:["perspective(800) rotate(0)",0],to:["perspective(800) rotate(0)",1]};iAP.MultiView.TRANSITION_SPIN_RIGHT_IN=iAP.MultiView.TRANSITION_SPIN_LEFT_IN;iAP.MultiView.prototype.init=function(a){this.switchingViews=[];this.nextButtons=[];this.previousButtons=[];this._timingFunction=iAP.MultiView.TIMING_FUNCTION_LINEAR;this._transitionDuration=0.5;this._transition="slide-flip";this._direction=iAP.MultiView.DIRECTION_LEFT;this._selectedIndex=0;this._buttonsPosition=iAP.MultiView.BUTTONS_POSITION_BOTTOM;this._hidesButtons=false;this._buttonStyle=iAP.MultiView.BUTTON_ICON_STYLE_DARK;this._hidesButtonsForLastCell=false;this._hidesButtonsDuringTransition=false;this._initialIndex=0;this.callSuper(a);this.setSelectedIndexAnimated(this.initialIndex,false);this.setupButtons();this.setButtonsPosition();this.analyticsDetails={cell:function(){return this.focusedCell().id}};if(this.initialIndex==0){this.enableViewDidAppear=true;this.dispatchNotification(iAP.MultiView.DID_FOCUS_CELL_AT_INDEX,this,[["index",this.selectedIndex]])}};iAP.MultiView.prototype.createLayer=function(){this.callSuper();this.createSwitchingContainer()};iAP.MultiView.prototype.setupLayer=function(){this.callSuper();var d=Array.prototype.slice.call(this.layer.childNodes);var c=d.filter(function(e){return e.nodeType==1});this.createSwitchingContainer();c.forEach(function(f){var e=f._view||new iAd.View(f);this.addSwitchableView(e)},this);var b=Array.prototype.slice.call(this.layer.querySelectorAll(".iap-next-button"));b.forEach(function(e){this.addNextButton(e._view)},this);var a=Array.prototype.slice.call(this.layer.querySelectorAll(".iap-previous-button"));a.forEach(function(e){this.addPreviousButton(e._view)},this)};iAP.MultiView.prototype.setSize=function(){this.callSuper.apply(this,arguments);this.setButtonsPosition()};iAP.MultiView.prototype.handleEvent=function(a){if(a.type===iAd.View.TOUCH_UP_INSIDE_EVENT){if(a.target._view&&this.previousButtons.indexOf(a.target._view)>-1){if(!this.busy){this.selectedIndex=this._selectedIndex-1}return}else{if(a.target._view&&this.nextButtons.indexOf(a.target._view)>-1){if(!this.busy){this.selectedIndex=this._selectedIndex+1}return}else{this.callSuper(a)}}}else{this.callSuper(a)}};iAP.MultiView.prototype.setButtonStyle=function(d){if(d!=this.buttonStyle){if(d===iAP.MultiView.BUTTON_ICON_STYLE_NONE){this.hidesButtons=true}else{this.hidesButtons=false;this.updateButtonsPosition()}}this._buttonStyle=d;var c=(d==iAP.MultiView.BUTTON_ICON_STYLE_LIGHT)?iAd.Button.TYPE_INFO_LIGHT:iAd.Button.TYPE_INFO_DARK;if(this.defaultPreviousButton){var b=this.defaultPreviousButton.layer;b.removeClassName(iAd.Button.TYPE_INFO_LIGHT);b.removeClassName(iAd.Button.TYPE_INFO_DARK);b.addClassName(c)}if(this.defaultNextButton){var a=this.defaultNextButton.layer;a.removeClassName(iAd.Button.TYPE_INFO_LIGHT);a.removeClassName(iAd.Button.TYPE_INFO_DARK);a.addClassName(c)}};iAP.MultiView.prototype.setHidesButtons=function(b){this._hidesButtons=b;var a;if(b==true){if(this.defaultPreviousButton){this.defaultPreviousButton.removeFromSuperview();a=this.previousButtons.indexOf(this.defaultPreviousButton);if(a>-1){this.previousButtons=[]}delete this.defaultPreviousButton}if(this.defaultNextButton){this.defaultNextButton.removeFromSuperview();a=this.nextButtons.indexOf(this.defaultPreviousButton);if(a>-1){this.nextButtons=[];this.nextButtons.splice(a,1)}delete this.defaultNextButton}}else{this.setupButtons()}};iAP.MultiView.prototype.setButtonsPosition=function(a){if(a){this._buttonsPosition=a}this.updateButtonsPosition()};iAP.MultiView.prototype.setDirection=function(a){if(this._direction==a){return}this._direction=a;this.updateButtonsPosition()};iAP.MultiView.prototype.setTransitionDuration=function(a){if(this._transitionDuration==a||isNaN(a)){return}this._transitionDuration=a};iAP.MultiView.prototype.setTransition=function(a){if(this._transition==a){return}this.switchingViews.forEach(function(b){b.layer.style.removeProperty("opacity");b.layer.style.removeProperty("-webkit-transform");b.layer.style.removeProperty("-webkit-transform-origin")});this._transition=a};iAP.MultiView.prototype.transitionFromName=function(e,d){var b=e.split("-");var f={door:{OPEN:"CLOSE",CLOSE:"OPEN"},revolve:{TOWARDS:"AWAY",AWAY:"TOWARDS"},zoom:{TOWARDS:"AWAY",AWAY:"TOWARDS"}}[b[0]]||{LEFT:"RIGHT",RIGHT:"LEFT",UP:"DOWN",DOWN:"UP"};b=b.map(function(g){g=g.toUpperCase();if(d){g=f[g]||g}return g});b.splice(0,0,"TRANSITION");var a=b.concat(["IN"]).join("_");var c=b.concat(["OUT"]).join("_");return[iAP.MultiView[a]||iAd.View[a],iAP.MultiView[c]||iAd.View[c]]};iAP.MultiView.prototype.setSelectedView=function(g,e,l){var i=this.selectedView;var c=this.cellAtIndex(g);var b=(c==this.selectedView);var f=this.cellCount-1;var d=this._selectedIndex;var j=(g<=d);if(g==0&&d==f){j=false}else{if(this.cellCount>2&&g==f&&d==0){j=true}}if(l){if(b&&!this.busy){l()}else{this._animationCallback=l}}if(!b){this.busy=true;if(!e||this.transition=="none"){this._selectedView=c;this._animatingLayer=c.layer;this.callMethodNameAfterDelay("transitionDidComplete",0,{target:this._selectedView});return}var h=this.transitionFromName(this.transition,j);c.layer.removeClassName("iap-switched-back");c.layer.addClassName("iap-multiview-incoming");i.layer.addClassName("iap-multiview-outgoing");if(this.transition.indexOf("door")!=-1){if(j){c.layer.addClassName("iap-multiview-front")}else{i.layer.addClassName("iap-multiview-front")}}iAd.Transaction.begin();var k=this.createTransition(h[0],"in");var a=this.createTransition(h[1],"out");if(e===false){a.delay=a.duration=0;k.delay=k.duration=0}else{k.delay=0.01;a.delay=0.01}a.target=i;a.start();k.delegate=this;k.target=c;k.start();this._animatingLayer=c.layer;this._selectedView=c;if(this.hidesButtonsDuringTransition){this.hideTransitionButtons()}iAd.Transaction.commit()}};iAP.MultiView.prototype.cloneObject=function(c){var a={};for(var b in c){a[b]=c[b]}return a};iAP.MultiView.prototype.reverseTransition=function(a){var b=a.from;a.from=a.to;a.to=b;return a};iAP.MultiView.prototype.createSwitchingContainer=function(){this.switchingContainer=new iAd.View();this.switchingContainer.layer.addClassName("switching-container");this.switchingContainer.position=new iAd.Point(0,0);this.addSubview(this.switchingContainer)};iAP.MultiView.prototype.createTransition=function(b,c){var a=new iAd.Transition(b);a.duration=this.transitionDuration;a.timingFunction=this.timingFunction;return a};iAP.MultiView.prototype.addSwitchableView=function(a){if(!this.usesDeclarativeBacking){this.switchingContainer.insertSubviewAtIndex(a,0)}else{a.removeFromSuperview();this.switchingContainer.addSubview(a)}this.switchingViews.push(a);this.setupSwitchView(a)};iAP.MultiView.prototype.setupSwitchView=function(a){if(!this.selectedView){this._selectedView=a}if(a!==this._selectedView){a.layer.addClassName("iap-switched-back")}a.layer.addClassName("iap-switch-view")};iAP.MultiView.prototype.updateViews=function(){this.switchingViews.forEach(function(a){a.layer.removeClassName("iap-multiview-incoming");a.layer.removeClassName("iap-multiview-outgoing");a.layer.removeClassName("iap-multiview-front");if(a==this.selectedView){a.layer.removeClassName("iap-switched-back")}else{a.layer.addClassName("iap-switched-back")}},this);this.showTransitionButtons()};iAP.MultiView.prototype.addNextButton=function(a){this.nextButtons.push(a);a.layer.addEventListener(iAd.View.TOUCH_UP_INSIDE_EVENT,this,false)};iAP.MultiView.prototype.addPreviousButton=function(a){this.previousButtons.push(a);a.layer.addEventListener(iAd.View.TOUCH_UP_INSIDE_EVENT,this,false)};iAP.MultiView.prototype.setupButtons=function(){if(!this.hidesButtons){if(!this.defaultNextButton){this.defaultNextButton=this.createFlipButtonAndAddToView(this);this.addNextButton(this.defaultNextButton)}if(!this.defaultPreviousButton){this.defaultPreviousButton=this.createFlipButtonAndAddToView(this);this.addPreviousButton(this.defaultPreviousButton)}this.showTransitionButtons()}};iAP.MultiView.prototype.createFlipButtonAndAddToView=function(a){var b=(this.buttonStyle==iAP.MultiView.BUTTON_ICON_STYLE_LIGHT)?iAd.Button.TYPE_INFO_LIGHT:iAd.Button.TYPE_INFO_DARK;var c=new iAd.Button(null,b);c.size=new iAd.Size(iAP.MultiView.BUTTON_WIDTH,iAP.MultiView.BUTTON_HEIGHT);c.layer.addClassName("iap-switch-button");a.addSubview(c);return c};iAP.MultiView.prototype.updateButtonsPosition=function(){if(this.defaultPreviousButton){this.defaultPreviousButton.position=this.buttonPosition(this.defaultPreviousButton,this,"previous")}if(this.defaultNextButton){this.defaultNextButton.position=this.buttonPosition(this.defaultNextButton,this,"next")}};iAP.MultiView.prototype.buttonPosition=function(d,b,c){var a;if(this.buttonsPosition){if(typeof(this.buttonsPosition)==="string"){var f=0;var e=0;if((this.direction===iAP.MultiView.DIRECTION_RIGHT)?(c==="previous"):(c==="next")){e=b.size.width-iAP.MultiView.BUTTON_WIDTH-iAP.MultiView.BUTTON_INSET}else{e+=iAP.MultiView.BUTTON_INSET}if(this.buttonsPosition.indexOf(iAP.MultiView.BUTTONS_POSITION_BOTTOM)>-1){f=b.size.height-iAP.MultiView.BUTTON_HEIGHT-iAP.MultiView.BUTTON_INSET}else{f+=iAP.MultiView.BUTTON_INSET}a=new iAd.Point(e,f)}else{a=this.buttonsPosition}}else{a=new iAd.Point(0,0)}return a};iAP.MultiView.prototype.hideTransitionButtons=function(){this.changeButtonShowing(this.nextButtons,false);this.changeButtonShowing(this.previousButtons,false)};iAP.MultiView.prototype.showTransitionButtons=function(){var a=this._selectedIndex;if(this.hidesButtonsForLastCell){if(a==0){this.changeButtonShowing(this.previousButtons,false);return}else{if(a==this.cellCount-1){this.changeButtonShowing(this.nextButtons,false);this.changeButtonShowing(this.previousButtons,false);return}}}this.changeButtonShowing(this.nextButtons,true);this.changeButtonShowing(this.previousButtons,false)};iAP.MultiView.prototype.changeButtonShowing=function(a,b){a.forEach(function(c){c.layer.style.display=(b)?"block":"none"})};iAP.MultiView.prototype.invertDirection=function(b){var a={};a[iAP.MultiView.DIRECTION_UP]=iAP.MultiView.DIRECTION_DOWN;a[iAP.MultiView.DIRECTION_DOWN]=iAP.MultiView.DIRECTION_UP;a[iAP.MultiView.DIRECTION_LEFT]=iAP.MultiView.DIRECTION_RIGHT;a[iAP.MultiView.DIRECTION_RIGHT]=iAP.MultiView.DIRECTION_LEFT;return a[b]};iAP.MultiView.prototype.nextView=function(){iAd.Console.warn("iAP.MultiView.nextView() is deprecated.  See iAP.MultiView.setSelectedIndex().");if(!this.busy){this.selectedIndex=this._selectedIndex+1}};iAP.MultiView.prototype.previousView=function(){iAd.Console.warn("iAP.MultiView.previousView() is deprecated.  See iAP.MultiView.setSelectedIndex().");if(!this.busy){this.selectedIndex=this._selectedIndex-1}};iAP.MultiView.prototype.getCellCount=function(){return this.switchingViews.length};iAP.MultiView.prototype.setCellCount=function(){console.warn("cellCount is a read-only property")};iAP.MultiView.prototype.getNumberOfCells=function(){return this.switchingViews.length};iAP.MultiView.prototype.cellAtIndex=function(a){return this.switchingViews[a]};iAP.MultiView.prototype.setSelectedIndex=function(a){this.setSelectedIndexAnimated(a,true)};iAP.MultiView.prototype.setSelectedIndexAnimated=function(a,b,d){var c=this.cellCount-1;if(a<0){a=c}else{if(a>c){a=0}}this.setSelectedView(a,b,d);this._selectedIndex=a};iAP.MultiView.prototype.insertChildAtIndexPath=function(e,b,c,d){var a=b.indexAtPosition?b.indexAtPosition(0):b[0];this.switchingContainer.insertSubviewAtIndex(e,a);this.switchingViews.splice(a,0,e);this.setupSwitchView(e);if(c){this.setSelectedIndexAnimated(a,true,d)}else{if(d){d()}}};iAP.MultiView.prototype.removeChildAtIndexPath=function(b,e,f){var a=b.indexAtPosition?b.indexAtPosition(0):b[0];var d=this.cellAtIndex(a);this.switchingViews.splice(a,1);d.removeFromSuperview();if(a<this.selectedIndex){this.setSelectedIndexAnimated(this.selectedIndex-1,true,f)}else{if(a==this.selectedIndex){var c=(a>=this.cellCount?this.cellCount-1:a);this.setSelectedIndexAnimated(c,true,f)}else{if(f){f()}}}};iAP.MultiView.prototype.getChildAtIndexPath=function(b){var a=b.indexAtPosition?b.indexAtPosition(0):b[0];return this.cellAtIndex(a)};iAP.MultiView.prototype.transitionDidComplete=function(a){this.updateViews();delete this.busy;this.dispatchNotification(iAP.MultiView.DID_FOCUS_CELL_AT_INDEX,this,[["index",this.selectedIndex]]);if(this._animationCallback&&this._animatingLayer==a.target.layer){var b=this._animationCallback;delete this._animationCallback;b()}this.viewDidAppear();this.enableViewDidAppear=true};iAP.MultiView.prototype.focusedCell=function(){return this.cellAtIndex(this.selectedIndex)};iAP.MultiView.prototype.viewDidAppear=function(){if(!this.enableViewDidAppear){return}var a=this.focusedCell();if(!a){return}a.createAndDispatchEvent("containerCellDidAppear");a.viewDidAppear()};