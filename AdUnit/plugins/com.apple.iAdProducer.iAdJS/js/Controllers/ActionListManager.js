
/**
*
* Copyright Â© 2009-2011 Apple Inc.  All rights reserved.
*
**/

iAd.Class({name:"iAd.ActionListManager",mixins:[iAd.EventTarget]});iAd.ActionListManager.ACTIVE_STATE_SUFFIX="-is-active";iAd.ActionListManager.ACTION_LIST_WILL_START="actionListWillStart";iAd.ActionListManager.ACTION_LIST_DID_START="actionListDidStart";iAd.ActionListManager.ACTION_LIST_WILL_ITERATE="actionListWillIterate";iAd.ActionListManager.ACTION_LIST_DID_ITERATE="actionListDidIterate";iAd.ActionListManager.ACTION_LIST_WILL_COMPLETE="actionListWillComplete";iAd.ActionListManager.ACTION_LIST_DID_COMPLETE="actionListDidComplete";iAd.ActionListManager.ACTION_LIST_DID_CANCEL="actionListDidCancel";iAd.ActionListManager.ACTION_LIST_DID_PROGRESS="actionListDidProgress";iAd.ActionListManager.prototype.init=function(c,d){this.callSuper();this.eventTarget=document;this.id=c.id||iAd.ActionListManager.uniqueId();this.actionList=c;this.viewController=d;this.actionsByName={};this.actions=[];this.seedActions=[];this.actionQueue=[];this.dependency={};this.selectors=[];this.timers=[];this.usesAnimationIterationCount=true;var b,a;this.actionList.actions.forEach(function(i){var n=i.type;if(n=="css-reset"){this.selectors.push(i.selector);return}var e=i.name,g=i.startAfter||[];if(n=="script"){var j=i.className,f=iAd.Utils.resolveObjectPath(j);if(!f){throw new ReferenceError("Can't find script action class named: "+j)}var l=new f(this.viewController);var m=i.properties;for(var o in m){l[o]=m[o]}if(i.delay){l.delay=i.delay}if(!i.asynchronous){l.delegate=this}l._action=i;l.prepare();i.object=l;this.usesAnimationIterationCount=false}else{if(n=="css"){this.selectors.push(i.selector);var h=i.duration||0;if(b==null){b=h}else{if(b!=h){this.usesAnimationIterationCount=false}}var k=i.delay||0;if(a==null){a=k}else{if(a!=k){this.usesAnimationIterationCount=false}}}}if(g.length>0){g.forEach(function(p){if(this.dependency[p]){this.dependency[p].push(i)}else{this.dependency[p]=[i]}},this);this.usesAnimationIterationCount=false}else{this.seedActions.push(i)}if(e){this.actionsByName[e]=i}i.completed=false;this.actions.push(i)},this);this.totalIterations=this.actionList.iterationCount||1;this.totalActions=this.actions.length};iAd.ActionListManager.prototype.start=function(){if(this.viewController.isInState(this.actionList.cssClassName)){this.reset(true);this.callMethodNameAfterDelay("start",0);return}this.clearCSSAnimationProperties();this.dispatchNotification(iAd.ActionListManager.ACTION_LIST_WILL_START,this.viewController,[["actionList",this.actionList]]);this.viewController.enterState(this.actionList.cssClassName);this.viewController.enterState(this.actionList.cssClassName+iAd.ActionListManager.ACTIVE_STATE_SUFFIX);this.viewController.view.layer.addEventListener("webkitAnimationEnd",this,true);if(this.usesAnimationIterationCount){this.viewController.view.layer.addEventListener("webkitAnimationIteration",this,true)}this.completedIterationCount=0;this.iterate();this.dispatchNotification(iAd.ActionListManager.ACTION_LIST_DID_START,this.viewController,[["actionList",this.actionList]])};iAd.ActionListManager.prototype.iterate=function(){this.dispatchNotification(iAd.ActionListManager.ACTION_LIST_WILL_ITERATE,this.viewController,[["actionList",this.actionList],["iteration",this.completedIterationCount]]);this.completedActionCount=0;this.actionQueue=this.seedActions.slice();this.flushActionQueue()};iAd.ActionListManager.prototype.clearCSSAnimationProperties=function(){if(this.selectors.length==0){return}var c=this.viewController.view.layer.querySelectorAll(this.selectors.join(","));for(var b=c.length-1;b>=0;b--){var a=c[b];a.style.webkitAnimationName="";a.style.webkitAnimationDuration="";a.style.webkitAnimationDelay="";a.style.webkitAnimationIterationCount=""}};iAd.ActionListManager.prototype.reset=function(a){this.clearCSSAnimationProperties();this.timers.forEach(clearTimeout);this.timers=[];this.actionQueue=[];this.actions.forEach(function(b){b.completed=false},this);this.viewController.exitState(this.actionList.cssClassName);this.viewController.exitState(this.actionList.cssClassName+iAd.ActionListManager.ACTIVE_STATE_SUFFIX);if(a!=true){this.dispatchNotification(iAd.ActionListManager.ACTION_LIST_DID_CANCEL,this.viewController,[["actionList",this.actionList]])}};iAd.ActionListManager.prototype.handleEvent=function(b){var c,a=b.type;if(a=="webkitAnimationEnd"||a=="webkitAnimationIteration"){c=this.actionsByName[b.animationName]}if(c==null||c.asynchronous){return}this.handleActionDidComplete(c)};iAd.ActionListManager.prototype.scriptActionDidComplete=function(a){this.handleActionDidComplete(a._action)};iAd.ActionListManager.prototype.handleActionDidComplete=function(d){d.completed=true;this.completedActionCount++;var a=this.totalIterations=="infinite"?0:(this.completedIterationCount*this.totalActions+this.completedActionCount)/(this.totalActions*this.totalIterations);this.dispatchNotification(iAd.ActionListManager.ACTION_LIST_DID_PROGRESS,this.viewController,[["actionList",this.actionList],["action",d],["progress",a]]);if(this.completedActionCount==this.totalActions){this.dispatchNotification(iAd.ActionListManager.ACTION_LIST_DID_ITERATE,this.viewController,[["actionList",this.actionList],["iteration",this.completedIterationCount]]);this.completedIterationCount++;if(this.totalIterations!="infinite"&&this.completedIterationCount==this.totalIterations){this.dispatchNotification(iAd.ActionListManager.ACTION_LIST_WILL_COMPLETE,this.viewController,[["actionList",this.actionList]]);this.viewController.view.layer.removeEventListener("webkitAnimationEnd",this,true);if(this.usesAnimationIterationCount){this.viewController.view.layer.removeEventListener("webkitAnimationIteration",this,true)}this.dispatchNotification(iAd.ActionListManager.ACTION_LIST_DID_COMPLETE,this.viewController,[["actionList",this.actionList]]);this.viewController.exitState(this.actionList.cssClassName+iAd.ActionListManager.ACTIVE_STATE_SUFFIX)}else{if(this.usesAnimationIterationCount){this.dispatchNotification(iAd.ActionListManager.ACTION_LIST_WILL_ITERATE,this.viewController,[["actionList",this.actionList],["iteration",this.completedIterationCount]]);this.completedActionCount=0}else{this.reset();this.callMethodNameAfterDelay("iterate",0)}}}else{var e=d.name;if(e){var m=this.dependency[e];if(m){for(var h=0,l=m.length;h<l;h++){var f=m[h];var c=f.startAfter;var n=true;for(var g=0,b=c.length;g<b;g++){var k=this.actionsByName[c[g]];if(k&&k.completed==false){n=false;break}}if(n){this.actionQueue.push(f)}}}}}this.flushActionQueue()};iAd.ActionListManager.prototype.flushActionQueue=function(){if(this.actionQueue.length==0){return}var e=[];var a={};var d=this.viewController.view.layer;this.actionQueue.forEach(function(m){var r=m.type;if(r=="css"){var g=d.querySelectorAll(m.selector),k=g.length;if(k>0){var q=m.name,s=m.duration+"s",h=m.delay||0+"s";for(var o=0;o<k;o++){var n=g[o];var j=n.id;if(!j){j=n.id=iAd.ActionListManager.uniqueId()}var l=a[j];if(!l){l=a[j]={keyframeNames:[q],durations:[s],delays:[h],element:n}}else{l.keyframeNames.push(q);l.durations.push(s);l.delays.push(h)}}}}else{if(r=="script"){var p=m.object;this.timers.push(p.run())}}if(m.asynchronous){e.push(m)}},this);for(var b in a){var f=a[b];var c=f.element;c.style.webkitAnimationName=f.keyframeNames.join(",");c.style.webkitAnimationDuration=f.durations.join(",");c.style.webkitAnimationDelay=f.delays.join(",");c.style.webkitAnimationFillMode="both";c.style.webkitAnimationIterationCount=this.usesAnimationIterationCount?this.totalIterations:""}this.actionQueue=[];e.forEach(this.handleActionDidComplete,this);this.flushActionQueue()};iAd.ActionListManager.uniqueId=function(){return"al-"+this._uid++};iAd.ActionListManager._uid=1;